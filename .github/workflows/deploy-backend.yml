name: Deploy Backend to EC2

on:
  push:
    branches:
      - dev
    paths:
      - 'Backend/**'
      - 'AI/**'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy-backend:
    name: Deploy Backend + AI with Docker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Backend EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.BACKEND_HOST }}
          username: ubuntu
          key: ${{ secrets.BACKEND_SSH_KEY }}
          script: |
            echo "=========================================="
            echo "ğŸš€ Starting Backend Deployment with Docker"
            echo "=========================================="
            echo "ğŸ“ Backend Server: 13.250.231.18"
            echo ""

            # Navigate to deployment directory
            cd /var/www/backend || exit 1

            # Backup old version (if exists)
            if [ -d "DevAlign" ]; then
              echo "ğŸ“¦ Backing up current version..."
              rm -rf DevAlign-backup
              cp -r DevAlign DevAlign-backup
              echo "âœ… Backup created"
            fi

            # Clone or pull latest code from dev branch
            if [ -d "DevAlign" ]; then
              echo "ğŸ“¥ Pulling latest changes from dev branch..."
              cd DevAlign
              git fetch origin dev
              git reset --hard origin/dev
              git pull origin dev
            else
              echo "ğŸ“¥ Cloning repository..."
              git clone -b dev https://github.com/PentabyteDevAlign/DevAlign.git
              cd DevAlign
            fi

            echo "âœ… Code updated successfully"
            echo ""

            # Copy environment files from secure location
            echo "âš™ï¸ Copying environment variables..."
            cp /var/www/backend/.env.backend Backend/.env
            cp /var/www/backend/.env.ai AI/.env
            echo "âœ… Environment files copied"
            echo ""

            # Stop existing Docker containers
            echo "ğŸ›‘ Stopping existing Docker containers..."
            docker compose down 2>/dev/null || true
            echo "âœ… Containers stopped"
            echo ""

            # Remove old images to save space (optional, but recommended)
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -f
            echo ""

            # Build and start containers
            echo "ğŸ”¨ Building and starting Docker containers..."
            docker compose up -d --build

            # Wait for containers to be healthy
            echo ""
            echo "â³ Waiting for containers to start (10 seconds)..."
            sleep 10

            # Check container status
            echo ""
            echo "ğŸ“Š Container Status:"
            docker compose ps

            # Show container logs (last 20 lines)
            echo ""
            echo "ğŸ“‹ Recent Backend Logs:"
            docker compose logs --tail=20 backend

            echo ""
            echo "ğŸ“‹ Recent AI Backend Logs:"
            docker compose logs --tail=20 ai-backend

            echo ""
            echo "=========================================="
            echo "âœ… Backend Deployment Complete!"
            echo "=========================================="
            echo "ğŸŒ Backend API: http://13.250.231.18:5000"
            echo "ğŸ¤– AI API: http://13.250.231.18:8000"
            echo ""
            echo "ğŸ“Š Check logs with:"
            echo "   docker compose logs -f backend"
            echo "   docker compose logs -f ai-backend"
            echo ""
            echo "ğŸ”„ Restart containers with:"
            echo "   docker compose restart"
            echo "=========================================="
